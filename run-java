#!/bin/sh -e

. ./config

TEST_FORMATS_JAVA_DIR=$(pwd)/compiled/java/src/io/kaitai/struct/testformats
JAVA_SPEC_DIR=$(pwd)/spec/java/src/io/kaitai/struct/spec
JAVA_SPEC_ROOT_DIR=$(pwd)/spec/java/src
JAVA_CLASSES_DIR=$(pwd)/compiled/java/bin
JAVA_BUILD_FAILS=$(pwd)/"$TEST_OUT_DIR"/java/build.fails
JAVA_COMPILE_LOG_DIR=$(pwd)/"$TEST_OUT_DIR"/java/compile_log
JAVAC_OPTS='-encoding UTF-8'

# Compile everything:
rm -f "$JAVA_BUILD_FAILS"
rm -rf "$JAVA_COMPILE_LOG_DIR"
mkdir -p "$JAVA_CLASSES_DIR" "$JAVA_COMPILE_LOG_DIR"

# 1. KS runtime part for Java
# If this fails, there's no point to continue Java compilation
echo "run-java: compling KS runtime part for Java"
javac $JAVAC_OPTS "$JAVA_RUNTIME_DIR/src/main/java/io/kaitai/struct/"*.java -d "$JAVA_CLASSES_DIR"

# 2. Prerequisites for generated binary format parsers
# This should never fail as well
echo "run-java: compiling parser prerequisites"
javac $JAVAC_OPTS -cp "$JAVA_CLASSES_DIR" \
	"$JAVA_SPEC_ROOT_DIR/io/kaitai/struct/testformats/"*.java \
	"$JAVA_SPEC_ROOT_DIR/nested/deeply/"*.java \
	-d "$JAVA_CLASSES_DIR"

# 3. Binary format parser sources, generated by KS compiler
# If this fails to compile as a group, try compiling individual files
echo "run-java: compiling binary format parser sources, generated by KS compiler"
javac $JAVAC_OPTS -cp "$JAVA_CLASSES_DIR" \
	"$TEST_FORMATS_JAVA_DIR"/*.java \
	-d "$JAVA_CLASSES_DIR" || {
	echo "run-java: some formats failed to compile, trying one by one"

	# NB: Several files are prepended to file globbing as they're
	# import dependencies which are to be compiled before files which
	# actually use them.

	# Special workaround for circular dependency test
	(
		javac -cp "$JAVA_CLASSES_DIR" \
			"$TEST_FORMATS_JAVA_DIR/ImportsCircularA.java" \
			"$TEST_FORMATS_JAVA_DIR/ImportsCircularB.java" \
			-d "$JAVA_CLASSES_DIR" 2>&1 || {
			echo "ImportsCircularA.java" >>"$JAVA_BUILD_FAILS"
			echo "ImportsCircularB.java" >>"$JAVA_BUILD_FAILS"
		}
	) | tee "$JAVA_COMPILE_LOG_DIR/$SRC.log"

	for TFJ in \
		"$TEST_FORMATS_JAVA_DIR/HelloWorld.java" \
		"$TEST_FORMATS_JAVA_DIR/ImportedRoot.java" \
		"$TEST_FORMATS_JAVA_DIR/Imported2.java" \
		"$TEST_FORMATS_JAVA_DIR/VlqBase128Le.java" \
		"$TEST_FORMATS_JAVA_DIR"/*.java; do
		SRC=$(basename "$TFJ")
		echo "$SRC"
		(
			javac -cp "$JAVA_CLASSES_DIR" "$TFJ" -d "$JAVA_CLASSES_DIR" 2>&1 ||
			echo "$SRC" >>"$JAVA_BUILD_FAILS"
		) | tee "$JAVA_COMPILE_LOG_DIR/$SRC.log"
	done
}

# 4. Test specs
# If this fails to compile as a group, try compiling individual files
echo "run-java: compiling test specs"
javac $JAVAC_OPTS -cp "$JAVA_CLASSES_DIR:$JAVA_TESTNG_JAR" \
	"$JAVA_SPEC_DIR/"*.java \
	-d "$JAVA_CLASSES_DIR" || {
	echo "run-java: some test specs failed to compile, trying one by one"
	for SPEC in "$JAVA_SPEC_DIR"/*.java; do
		SRC=$(basename "$SPEC")
		echo "$SRC"
		(
			javac $JAVAC_OPTS -cp "$JAVA_CLASSES_DIR:$JAVA_TESTNG_JAR" "$SPEC" -d "$JAVA_CLASSES_DIR" 2>&1 ||
			echo "$SRC" >>"$JAVA_BUILD_FAILS"
		) | tee "$JAVA_COMPILE_LOG_DIR/$SRC.log"
	done
}

# Actually run the tests
cd spec/java
java -cp "$JAVA_CLASSES_DIR:$JAVA_TESTNG_JAR" \
	org.testng.TestNG -d "../../$TEST_OUT_DIR/java" testng.xml
